This section corresponds to transaction Get **Consent Access Token** \[ITI-108\] transaction of the IHE Technical Framework. Transaction \[ITI-108\] is used by the Client to request an authorization decision based on consents. This transaction is a refinement of the [IUA Get Access Token \[ITI-71\]](https://profiles.ihe.net/ITI/IUA/index.html#371-get-access-token-iti-71).

TODO: Seems we would ONLY use the IUA JWT Token Option? Meaning we would not use in PCF the SAML or the BPPC options.

### 3.108.1 Scope

This transaction is used by an Authorization Client to retrieve an OAuth 2.1-compliant access token. This is distinct from [ITI-71](https://profiles.ihe.net/ITI/IUA/index.html#371-get-access-token-iti-71) in that the Authorization Decision is informed by a Consent that is compliant with the PCF [Consent Content Profiles](volume-1.html#actor-options).

### 3.108.2 Actors Roles

This transaction defines the following actors and roles:

**Table 3.108.2-1: Actor Roles**

| Actor                | Role                                                                        |
|----------------------|-----------------------------------------------------------------------------|
| [Consent Authorization Client](volume-1.html#consentAuthorizationClient) | Client requesting an access token to authorize RESTful transactions         |
| [Consent Authorization Server](volume-1.html#consentAuthorizationServer) | Server that grants access tokens.                                           |
{: .grid}

#### 2:3.110.2.1 CapabilityStatement Resource

This transaction does not use FHIR, so there is no CapabilityStatement Resource associated with this transaction.

### 3.108.3 Referenced Standards

This transaction relies on standards defined in the following documents and the references therein:

- *OAuth 2.1*: The OAuth 2.1 Authorization Framework, published as [draft-ietf-oauth-v2-1-01](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-v2-1-01), 1 February 2021.
- *JWT Access Token*: JSON Web Token (JWT) Profile for OAuth 2.0 Access Tokens, published as [draft-ietf-oauth-access-token-jwt-10](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-access-token-jwt-10), September 2020.
- *[RFC7519](https://www.rfc-editor.org/rfc/rfc7519)*: JSON Web Token (JWT), May 2015.  
- *[RFC7515](https://www.rfc-editor.org/rfc/rfc7515)*: JSON Web Signature (JWS), May 2015.
- *[RFC7518](https://www.rfc-editor.org/rfc/rfc7518)*: JSON Web Algorithms (JWA), May 2015.
- *[RFC4648](https://www.rfc-editor.org/rfc/rfc4648)*: The Base16, Base32, and Base64 Data Encodings, October 2006

TODO: Should I just reference 71 references section? What about the drafts that have changed? Is it a problem to replicate this section?

### 3.108.4 Interactions

<div>
{%include ITI-108-seq.svg%}
</div>
<br clear="all">

**Figure: 2:3.108.4-1 Get Consent Token interactions**

#### 3.108.4.1 Get Consent Access Token Request

The Get Consent Access Token Request is performed by an Authorization Client to obtain an access token to be used in further communication.

TODO do we need to mention the grant types, or relying on IUA enough? How do we connect this well to IUA?

##### 3.108.4.1.1 Trigger Events

The Authorization Client needs a valid access token.

##### 3.108.4.1.2 Message Semantics

The message semantics are identical to IUA [ITI-71 Get Access Token Request](https://profiles.ihe.net/ITI/IUA/index.html#371-get-access-token-iti-71)

##### 3.108.4.1.3 Expected Actions

The expected actions include the expected actions in IUA [ITI-71 Get Access Token Request](https://profiles.ihe.net/ITI/IUA/index.html#371-get-access-token-iti-71), and also evaluation of the Consent available for the Patient following the PCF Content Profiles.

#### 3.108.4.2 Get Consent Access Token Response

The Get Consent Access Token Response is the response to a request.

##### 3.108.4.2.1 Trigger Events

An Access Control decision has been made.

##### 3.108.4.2.2 Message Semantics

The message semantics shall comply with the IUA [ITI-71 Get Access Token Response](https://profiles.ihe.net/ITI/IUA/index.html#37142-get-access-token-response).

TODO: Determine if there is any additional attributes needed. Without support for obligations, it would seem there is no additional requirements.

TODO: The following is inspired by the BPPC option in IUA

The Authorization Server and Resource Server shall support the following extension parameter:

- *patient_id*: Patient identifier related to the Patient Privacy Policy Identifier. Its value should  be the patient identifier in CX syntax or as a FHIR full URL.

- *doc_id*: Patient Privacy Policy Acknowledgment Document. Its value should  be an URN or as a FHIR full URL.

- *acp*: Patient Privacy Policy Identifier.

If present, the claims shall be wrapped in an "extensions" object with key 'ihe_pcf' and a JSON value object containing the claims, e.g.,

```json
"extensions" : {  
  "ihe_pcf" : {  
    "patient_id": "http://example.org/fhir/Patient/1",
    "doc_id": "http://example.org/fhir/Consent/1",
    "acp": "http://example.org/policies/privacyPolicy1",
    "other_value": "..."    
  }  
}
```

##### 3.108.4.2.3 Expected Actions

The Authorization Client shall use the token given, such as with the IUA [ITI-72](https://profiles.ihe.net/ITI/IUA/index.html#372-incorporate-access-token-iti-72).

### Security Considerations

See
[PCF Security Considerations](volume-1.html#security-considerations) and
[IUA ITI-71 Security Considerations](https://profiles.ihe.net/ITI/IUA/index.html#3715-security-considerations).

#### Security Audit Considerations

The Authorization Server shall record all authorization decisions, the Authorization Client should record all authorization requests.

##### Authorization Server Audit

The Authorization Server when grouped with ATNA Secure Node or Secure Application Actor shall be able to record [Consent Authorized Decision Audit Message](https://profiles.ihe.net/ITI/BALP/content.html#3576-consent-authorized-decision-audit-message) as defined in IHE ITI-BALP implementation guide.

##### Authorization Client Audit

The Authorization Server when grouped with ATNA Secure Node or Secure Application Actor should be able to record [User Authentication Audit Message](https://profiles.ihe.net/ITI/IUA/index.html#37151-security-audit-considerations) as defined in IHE ITI-71 implementation guide.

TODO Likely should profile this based on BALP foundation. Also not clear that audit message in IUA is something the client can record.
