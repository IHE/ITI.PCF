@startuml
skinparam svgDimensionStyle false
hide footbox
autonumber
title "FHIR Request mediated by\nAuthorization Decision based on Consent"
participant "[[#consentclient Consent\nAuthorization Client]]" as client
participant "[[#consentdecision Consent\nAuthorization Server]]" as decision
box "Other Authorization Services"
participant "Open-ID-Connect" as oidc
participant "IUA Authorization Server" as IUA
end box
box "Server"
participant "[[#consentenforce Consent Enforcement\nResource Server]]" as server
participant "FHIR Server" as fhir
end box
participant "[[#consentregistry Consent Registry]]" as registry
activate client
client ->o decision : Get Access Token [[ITI-Y2.html ITI-Y2]]
activate decision
decision --> oidc : Get authorized user using Open-ID-Connect
decision --> IUA : Get Access Token [ITI-71]
activate registry
decision ->o registry : [[ITI-Y1.html ITI-Y1]] - Query for existing Consent
registry --> decision : Some Found
note over registry : Record AuditEvent
deactivate registry

decision -> decision : Match provisions to request context
decision -> decision : Make Access Control Decision and encode in oAuth token
note over decision : Record AuditEvent

decision --> client:  Decision to be Enforced
client ->o server : "IUA: Incorporate Access Token [[https://profiles.ihe.net/ITI/IUA/index.html#372-incorporate-access-token-iti-72 ITI-72]]"
activate server
server -->o decision : "Introspect Token [[ITI-Y3.html ITI-Y3]]"
server -> server: Enforce authorization decision
server --> fhir : execute request
server -> server: Enforce authorization decision
client <- server : Returned authoried results
deactivate server
deactivate decision 

note over server : Record AuditEvent
deactivate server

note over client : Record AuditEvent
deactivate client 
@enduml
